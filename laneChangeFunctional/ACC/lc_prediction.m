clc
clear all
close all


lane_keeping = importfile('keep.csv');
lane_change = importfile('lanechange.csv');
lane_keeping = table2array(lane_keeping(2:end,:));
lane_change = table2array(lane_change(2:end,:));

c0_l =  lane_keeping(:,1);
c0_r =  lane_keeping(:,3);
c1_l =  lane_keeping(:,2);
c1_r =  lane_keeping(:,4);
c0_l_c =  lane_change(:,1);
c0_r_c =  lane_change(:,3);
c1_l_c =  lane_change(:,2);
c1_r_c =  lane_change(:,4);

lane_keeping_data = [];
lane_change_l_data = [];
lane_change_r_data = [];

lane_keeping_data(:,1) = 1/2 * (c0_l(:,1) + c0_r(:,1));
lane_keeping_data(:,2) = 1/2 * (c1_l(:,1) + c1_r(:,1));
lane_keeping_data(:,3) = ones(size(c0_l,1),1);

for i = 1: length(lane_change)
    if(c1_l_c(i)>0.01 && abs(c0_l_c(i)>0.1))
        if -(c0_l_c(i)+c0_r_c(i))/2 > 0
            deviation = -(c0_l_c(i)+c0_r_c(i))/2;
        else
            deviation = 3.15 -(c0_l_c(i)+c0_r_c(i))/2;
        end
        heading = (c1_l_c(i)+c1_r_c(i))/2;
        lane_change_l_data = [lane_change_l_data;[deviation,heading,2]];
    elseif (c1_l_c(i)<-0.01 && abs(c0_l_c(i)>0.1))
        if-(c0_l_c(i)+c0_r_c(i))/2 < 0
            deviation = -(c0_l_c(i)+c0_r_c(i))/2;
        else
            deviation = -3.15 -(c0_l_c(i)+c0_r_c(i))/2;
        end
        heading = (c1_l_c(i)+c1_r_c(i))/2;
        lane_change_r_data = [lane_change_r_data;[deviation,heading,3]];
    end
end
figure
plot(lane_keeping_data(:,1),lane_keeping_data(:,2),'*b')
hold on 
plot(lane_change_l_data(:,1),lane_change_l_data(:,2),'*r')
hold on 
plot(lane_change_r_data(:,1),lane_change_r_data(:,2),'*g')
hold on 
rate = [];
for i = 1:1000


train_set = [];
test_set = [];

randIndex = randperm(length(lane_keeping_data));
train_set = [train_set;lane_keeping_data(randIndex(1:480),:)];
test_set = [test_set;lane_keeping_data(randIndex(481:600),:)];

randIndex = randperm(length(lane_change_l_data));
train_set = [train_set;lane_change_l_data(randIndex(1:480),:)];
test_set = [test_set;lane_change_l_data(randIndex(481:600),:)];


randIndex = randperm(length(lane_change_r_data));
train_set = [train_set;lane_change_r_data(randIndex(1:480),:)];
test_set = [test_set;lane_change_r_data(randIndex(481:600),:)];

% figure
% plot(train_set(:,1),train_set(:,2),'*b')
% hold on 
% plot(test_set(:,1),test_set(:,2),'*r')
% hold off 


for i = 1: 3
        for j = 1:2
        mean_value(i,j) = mean(train_set(480*(i-1)+1 : 480*i,j));
        std_value(i,j) = sum((train_set(480*(i-1)+1 : 480*i,j)-mean_value(i,j)).^2) /120;
        end
    end

    prob = [];
    counter = 0;

    for i = 1:length(test_set)
        probk = [];
        for k = 1:3
            prob = 1;
            for j = 1:2
                iprob(j) = 1/sqrt(2*pi*std_value(k,j))*...
                    exp(-(test_set(i,j)-mean_value(k,j))^2/(2*std_value(k,j)^2));
                prob = prob * iprob(j);
            end
            probk = [probk,prob];
        end
        [value,loc] = max(probk);
        if (loc == test_set(i,end))
            counter = counter + 1;
        end
    end
    
    rate = [rate, counter/360.0];
end
 suc = mean(rate)
figure
plot(1:length(rate),rate)

function keep = importfile(filename, dataLines)
%IMPORTFILE Import data from a text file
%  KEEP = IMPORTFILE(FILENAME) reads data from text file FILENAME for
%  the default selection.  Returns the data as a table.
%
%  KEEP = IMPORTFILE(FILE, DATALINES) reads data for the specified row
%  interval(s) of text file FILENAME. Specify DATALINES as a positive
%  scalar integer or a N-by-2 array of positive scalar integers for
%  dis-contiguous row intervals.
%
%  Example:
%  keep = importfile("E:\jiangyunchengGit\laneChangeFunctional\ACC\keep.csv", [1, Inf]);
%
%  See also READTABLE.
%
% Auto-generated by MATLAB on 2021-05-14 10:30:41

%% Input handling

% If dataLines is not specified, define defaults
if nargin < 2
    dataLines = [1, Inf];
end

%% Setup the Import Options and import the data
opts = delimitedTextImportOptions("NumVariables", 139);

% Specify range and delimiter
opts.DataLines = dataLines;
opts.Delimiter = ",";

% Specify column names and types
opts.VariableNames = ["Var1", "Var2", "Var3", "Var4", "Var5", "Var6", "Var7", "Var8", "Var9", "Var10", "Var11", "Var12", "Var13", "Var14", "Var15", "Var16", "c0_position", "c1_heading_angle", "Var19", "Var20", "Var21", "Var22", "Var23", "Var24", "Var25", "Var26", "Var27", "Var28", "Var29", "Var30", "Var31", "Var32", "Var33", "Var34", "Var35", "Var36", "c0_position1", "c1_heading_angle1", "Var39", "Var40", "Var41", "Var42", "Var43", "Var44", "Var45", "Var46", "Var47", "Var48", "Var49", "Var50", "Var51", "Var52", "Var53", "Var54", "Var55", "Var56", "Var57", "Var58", "Var59", "Var60", "Var61", "Var62", "Var63", "Var64", "Var65", "Var66", "Var67", "Var68", "Var69", "Var70", "Var71", "Var72", "Var73", "Var74", "Var75", "Var76", "Var77", "Var78", "Var79", "Var80", "Var81", "Var82", "Var83", "Var84", "Var85", "Var86", "Var87", "Var88", "Var89", "Var90", "Var91", "Var92", "Var93", "Var94", "Var95", "Var96", "Var97", "Var98", "Var99", "Var100", "Var101", "Var102", "Var103", "Var104", "Var105", "Var106", "Var107", "Var108", "Var109", "Var110", "Var111", "Var112", "Var113", "Var114", "Var115", "Var116", "Var117", "Var118", "Var119", "Var120", "Var121", "Var122", "Var123", "Var124", "Var125", "Var126", "Var127", "Var128", "Var129", "Var130", "Var131", "Var132", "Var133", "Var134", "Var135", "Var136", "Var137", "Var138", "Var139"];
opts.SelectedVariableNames = ["c0_position", "c1_heading_angle", "c0_position1", "c1_heading_angle1"];
opts.VariableTypes = ["string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "double", "double", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "double", "double", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string", "string"];

% Specify file level properties
opts.ExtraColumnsRule = "ignore";
opts.EmptyLineRule = "read";

% Specify variable properties
opts = setvaropts(opts, ["Var1", "Var2", "Var3", "Var4", "Var5", "Var6", "Var7", "Var8", "Var9", "Var10", "Var11", "Var12", "Var13", "Var14", "Var15", "Var16", "Var19", "Var20", "Var21", "Var22", "Var23", "Var24", "Var25", "Var26", "Var27", "Var28", "Var29", "Var30", "Var31", "Var32", "Var33", "Var34", "Var35", "Var36", "Var39", "Var40", "Var41", "Var42", "Var43", "Var44", "Var45", "Var46", "Var47", "Var48", "Var49", "Var50", "Var51", "Var52", "Var53", "Var54", "Var55", "Var56", "Var57", "Var58", "Var59", "Var60", "Var61", "Var62", "Var63", "Var64", "Var65", "Var66", "Var67", "Var68", "Var69", "Var70", "Var71", "Var72", "Var73", "Var74", "Var75", "Var76", "Var77", "Var78", "Var79", "Var80", "Var81", "Var82", "Var83", "Var84", "Var85", "Var86", "Var87", "Var88", "Var89", "Var90", "Var91", "Var92", "Var93", "Var94", "Var95", "Var96", "Var97", "Var98", "Var99", "Var100", "Var101", "Var102", "Var103", "Var104", "Var105", "Var106", "Var107", "Var108", "Var109", "Var110", "Var111", "Var112", "Var113", "Var114", "Var115", "Var116", "Var117", "Var118", "Var119", "Var120", "Var121", "Var122", "Var123", "Var124", "Var125", "Var126", "Var127", "Var128", "Var129", "Var130", "Var131", "Var132", "Var133", "Var134", "Var135", "Var136", "Var137", "Var138", "Var139"], "WhitespaceRule", "preserve");
opts = setvaropts(opts, ["Var1", "Var2", "Var3", "Var4", "Var5", "Var6", "Var7", "Var8", "Var9", "Var10", "Var11", "Var12", "Var13", "Var14", "Var15", "Var16", "Var19", "Var20", "Var21", "Var22", "Var23", "Var24", "Var25", "Var26", "Var27", "Var28", "Var29", "Var30", "Var31", "Var32", "Var33", "Var34", "Var35", "Var36", "Var39", "Var40", "Var41", "Var42", "Var43", "Var44", "Var45", "Var46", "Var47", "Var48", "Var49", "Var50", "Var51", "Var52", "Var53", "Var54", "Var55", "Var56", "Var57", "Var58", "Var59", "Var60", "Var61", "Var62", "Var63", "Var64", "Var65", "Var66", "Var67", "Var68", "Var69", "Var70", "Var71", "Var72", "Var73", "Var74", "Var75", "Var76", "Var77", "Var78", "Var79", "Var80", "Var81", "Var82", "Var83", "Var84", "Var85", "Var86", "Var87", "Var88", "Var89", "Var90", "Var91", "Var92", "Var93", "Var94", "Var95", "Var96", "Var97", "Var98", "Var99", "Var100", "Var101", "Var102", "Var103", "Var104", "Var105", "Var106", "Var107", "Var108", "Var109", "Var110", "Var111", "Var112", "Var113", "Var114", "Var115", "Var116", "Var117", "Var118", "Var119", "Var120", "Var121", "Var122", "Var123", "Var124", "Var125", "Var126", "Var127", "Var128", "Var129", "Var130", "Var131", "Var132", "Var133", "Var134", "Var135", "Var136", "Var137", "Var138", "Var139"], "EmptyFieldRule", "auto");

% Import the data
keep = readtable(filename, opts);

end